<!DOCTYPE html> 
<html lang="en"> 
  <head> 
    <meta charset="UTF-8" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> 
    <title>MindAR Example</title> 
    <link rel="stylesheet" href="styles.css" /> 
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script> 

    <style> 
      body { 
        margin: 0; 
        overflow: hidden; /* ป้องกันการเลื่อน */ 
        touch-action: none; /* ป้องกันการสั่นไหวของหน้าจอ */
        user-select: none; /* ป้องกันการเลือกข้อความ */
        -webkit-user-select: none;
      } 
      #ar-container { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        z-index: 1; /* ให้แสดงอยู่ด้านบน */ 
      }
      
      /* แก้ปัญหากล้องหมุนบนมือถือ - แบบแน่นอน */
      a-scene {
        width: 100vw !important;
        height: 100vh !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
      }
      
      a-scene canvas,
      a-scene video {
        transform: none !important;
        -webkit-transform: none !important;
        -moz-transform: none !important;
        -ms-transform: none !important;
        object-fit: cover !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
      }

      /* บังคับให้กล้องอยู่ในทิศทางที่ถูกต้อง */
      @media screen and (orientation: portrait) {
        a-scene canvas,
        a-scene video {
          transform: rotate(0deg) !important;
          -webkit-transform: rotate(0deg) !important;
        }
      }

      @media screen and (orientation: landscape) {
        a-scene canvas,
        a-scene video {
          transform: rotate(0deg) !important;
          -webkit-transform: rotate(0deg) !important;
        }
      } 
      .exit-button { 
        position: absolute; 
        top: 20px; 
        right: 20px; 
        background-color: #ff4c4c; 
        color: white; 
        padding: 10px; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        z-index: 5; /* ทำให้ปุ่มอยู่ด้านบนสุด */ 
      } 
      .exit-button:hover { 
        background-color: #ff1c1c; 
      } 
    </style> 
  </head> 
  <body> 
    <button class="exit-button" onclick="exitScanner()">ออกจากการสแกน</button> 
    <div id="ar-container"> 
      <a-scene 
        mindar-image="imageTargetSrc: ./markers/targets1.mind; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;" 
        embedded
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium; antialias: false; alpha: true;"
        style="width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;">
        
        <!-- กล้อง --> 
        <a-camera
          position="0 0 0"
          rotation="0 0 0"
          look-controls="enabled: false"
          wasd-controls="enabled: false"
          cursor="rayOrigin: mouse"
          camera="active: true">
        </a-camera> 

        <!-- โมเดล 3D ที่จะปรากฏเมื่อสแกนภาพ P1.png ถึง P10.png --> 
        <!-- targetIndex: 0 = P1.png (หาดชะอำ) -->
        <a-entity mindar-image-target="targetIndex: 0" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Cha-am.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 1 = P2.png (วัดถ้ำแชง) -->
        <a-entity mindar-image-target="targetIndex: 1" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/cave temple.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 2 = P3.png (โครงการพระราชดำริ) -->
        <a-entity mindar-image-target="targetIndex: 2" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Chang Hua Mun Royal Initiative Project.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 3 = P4.png (วัดเขาบันไดอิฐ) -->
        <a-entity mindar-image-target="targetIndex: 3" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wat Khao Ban Dai It.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 4 = P5.png (วัดมหาธาตุ) -->
        <a-entity mindar-image-target="targetIndex: 4" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wat Mahathat.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 5 = P6.png (เขาวัง) -->
        <a-entity mindar-image-target="targetIndex: 5" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/khaowang.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 6 = P7.png (วัดขอย) -->
        <a-entity mindar-image-target="targetIndex: 6" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wat Khoi.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 7 = P8.png (พระราชวังบ้านปืน) -->
        <a-entity mindar-image-target="targetIndex: 7" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wang Ban Puen.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 8 = P9.png (วัดถ้ำแชง) -->
        <a-entity mindar-image-target="targetIndex: 8" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wat Tham Chaeng.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>

        <!-- targetIndex: 9 = P10.png (วัดปากน้อกทะเล) -->
        <a-entity mindar-image-target="targetIndex: 9" class="model" rotation="0 0 0"> 
          <a-entity gltf-model="model/Wat Nok Pak.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
        </a-entity>
      </a-scene> 
    </div> 

    <a-assets> 
  <a-asset-item id="cha-am-beach" src="model/Cha-am Beach.glb"></a-asset-item>
  <a-asset-item id="tham-chaeng-temple" src="model/Tham-Chaeng-Temple.glb"></a-asset-item>
  <a-asset-item id="chang-hua-man-royal-project" src="model/The-Chang-Hua-Man-Royal-Project.glb"></a-asset-item>
  <a-asset-item id="khao-bandai-it-temple" src="model/Khao-Bandai-It-Temple.glb"></a-asset-item>
  <a-asset-item id="phra-nakhon-khiri-historical-park" src="model/Phra-Nakhon-Khiri-Historical-Park.glb"></a-asset-item>
  <a-asset-item id="khoi-temple" src="model/Khoi-Temple.glb"></a-asset-item>
  <a-asset-item id="phra-ram-ratchaniwet" src="model/Phra-Ram-Ratchaniwet.glb"></a-asset-item>
  <a-asset-item id="wat-mahathat-worawihan" src="model/Wat-Mahathat-Worawihan.glb"></a-asset-item>
  <a-asset-item id="wat-pak-nok-thale" src="model/Wat-Pak-Nok-Thale.glb"></a-asset-item>
  <a-asset-item id="khao-yoi-cave-temple" src="model/Khao-Yoi-Cave-Temple.glb"></a-asset-item>
    </a-assets> 

    <script> 
      function exitScanner() { 
        const arContainer = document.getElementById("ar-container"); 
        arContainer.style.display = "none"; 
        window.location.assign("index.html"); 
      } 

      window.onload = function () { 
        const arContainer = document.getElementById("ar-container"); 
        arContainer.style.display = "block"; 
        
        // รอให้ MindAR โหลดเสร็จก่อน
        setTimeout(() => {
          startScanner(); 
          // เรียกฟังก์ชันแก้ปัญหาหมุนหลังจากเริ่มกล้อง
          fixCameraOrientation();
        }, 1000);

        // แก้ปัญหาหมุนทุกครั้งที่หน้าจอหมุน
        window.addEventListener('orientationchange', function() {
          setTimeout(fixCameraOrientation, 500);
        });

        // แก้ปัญหาหมุนเมื่อ resize หน้าจอ
        window.addEventListener('resize', function() {
          setTimeout(fixCameraOrientation, 500);
        });
        
        // ป้องกันการ zoom บนมือถือ
        document.addEventListener('touchmove', function (event) {
          if (event.scale !== 1) { 
            event.preventDefault(); 
          }
        }, { passive: false });
        
        // ป้องกันการ double tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);

        // บังคับแก้ปัญหาหมุนทุก 3 วินาที
        setInterval(fixCameraOrientation, 3000);
      }; 

      function startScanner() { 
        // ตรวจสอบว่าเป็นมือถือหรือไม่
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // กำหนด constraints สำหรับกล้อง - บังคับทิศทาง
        const constraints = {
          video: {
            facingMode: "environment", // ใช้กล้องหลัง
            width: { ideal: 1280, max: 1920 },
            height: { ideal: 720, max: 1080 },
            frameRate: { ideal: 30, max: 60 }
          }
        };

        // แก้ปัญหาหมุนสำหรับ iOS
        if (isMobile) {
          // บังคับให้หน้าจออยู่ในโหมด portrait
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait-primary').catch(() => {
              console.log('Cannot lock orientation');
            });
          }
        }

        navigator.mediaDevices 
          .getUserMedia(constraints) 
          .then((stream) => { 
            console.log("Camera access granted");
            
            // เพิ่มการแก้ปัญหาหมุนใน video stream
            const videoTrack = stream.getVideoTracks()[0];
            if (videoTrack) {
              const settings = videoTrack.getSettings();
              console.log('Camera settings:', settings);
            }
          }) 
          .catch((error) => { 
            console.error("Error accessing the camera:", error);
            // ลองใช้ constraints ง่ายกว่า
            navigator.mediaDevices
              .getUserMedia({ 
                video: { 
                  facingMode: "environment",
                  width: 640,
                  height: 480
                } 
              })
              .then((stream) => {
                console.log("Camera access granted with basic constraints");
              })
              .catch((err) => {
                console.error("Camera access failed:", err);
                alert("ไม่สามารถเข้าถึงกล้องได้ กรุณาอนุญาตการใช้งานกล้องในเบราว์เซอร์");
              });
          }); 
      }

      // ฟังก์ชันแก้ปัญหาหมุนหลังจากโหลดเสร็จ
      function fixCameraOrientation() {
        setTimeout(() => {
          const videos = document.querySelectorAll('video');
          const canvases = document.querySelectorAll('canvas');
          
          videos.forEach(video => {
            video.style.transform = 'none';
            video.style.webkitTransform = 'none';
            video.style.objectFit = 'cover';
            video.style.width = '100vw';
            video.style.height = '100vh';
            video.style.position = 'fixed';
            video.style.top = '0';
            video.style.left = '0';
          });

          canvases.forEach(canvas => {
            canvas.style.transform = 'none';
            canvas.style.webkitTransform = 'none';
            canvas.style.width = '100vw';
            canvas.style.height = '100vh';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
          });
        }, 2000);
      } 

      // ฟังก์ชันการหมุนโมเดล
      const models = document.querySelectorAll('.model');

      models.forEach(model => {
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        model.addEventListener('mousedown', (event) => {
          isDragging = true;
          previousMousePosition = { x: event.clientX, y: event.clientY };
        });

        model.addEventListener('mouseup', () => {
          isDragging = false;
        });

        model.addEventListener('mouseleave', () => {
          isDragging = false;
        });

        model.addEventListener('mousemove', (event) => {
          if (isDragging) {
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;

            const rotation = model.getAttribute('rotation');
            model.setAttribute('rotation', {
              x: rotation.x + deltaY * 0.1,
              y: rotation.y + deltaX * 0.1,
              z: rotation.z
            });

            previousMousePosition = { x: event.clientX, y: event.clientY };
          }
        });
      });
    </script> 
  </body> 
</html>
